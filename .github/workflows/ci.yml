name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Trigger deploy?'
        required: true
        default: 'false'

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build and test
        run: make pipeline

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-test-reports
          path: |
            **/target/surefire-reports/**
            **/target/failsafe-reports/**
            **/target/surefire-unittest-reports/**
            **/target/surefire-integtest-reports**

  # Deployment to Google Cloud App Engine:
  # 1) In GCP, create a service account with roles:
  #    - App Engine Admin
  #    - Cloud Build Editor
  #    - Storage Admin
  #    (Principle of least privilege: adjust as needed for your setup.)
  # 2) Create a JSON key for that service account and copy its file contents.
  # 3) In GitHub, go to: Settings > Secrets and variables > Actions > New repository secret
  #    - Name: GCP_PROJECT_ID, Value: your GCP project ID (e.g., my-gcp-project)
  #    - Name: GCP_SA_KEY,    Value: the entire JSON key content from step 2
  # The deploy job runs only on push events to the main branch, after a successful build.

  deploy:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
      # Required so Maven has the sources to package and deploy
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Compute deploy version (G_VERSION)
        run: |
          SHA=$(git rev-parse --short HEAD)
          if [ -n "${GITHUB_RUN_NUMBER}" ]; then SUFFIX="-$GITHUB_RUN_NUMBER"; else SUFFIX=""; fi
          echo "G_VERSION=${SHA}${SUFFIX}" >> $GITHUB_ENV

      - name: Deploy to App Engine
        env:
          CLOUDSDK_CORE_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
        run: ./mvnw -pl webapp -B -ntp -DskipTests package appengine:deploy
